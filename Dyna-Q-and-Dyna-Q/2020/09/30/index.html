<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="PfeH4jmhwL">
<meta name="google-site-verification" content="A749_BVo91Gbd5oqBRsAAzolnmY_5JCET--CVn3ZQQA">








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=PingFang SC:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Didot:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="BLOG">





  <link rel="alternate" href="/atom.xml" title="RUOCHI.AI" type="application/atom+xml">






<meta name="description" content="Assignment: Dyna-Q and Dyna-Q+Welcome to this programming assignment! In this notebook, you will:  implement the Dyna-Q and Dyna-Q+ algorithms.  compare their performance on an environment which chang">
<meta property="og:type" content="article">
<meta property="og:title" content="Dyna-Q and Dyna-Q+">
<meta property="og:url" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/index.html">
<meta property="og:site_name" content="RUOCHI.AI">
<meta property="og:description" content="Assignment: Dyna-Q and Dyna-Q+Welcome to this programming assignment! In this notebook, you will:  implement the Dyna-Q and Dyna-Q+ algorithms.  compare their performance on an environment which chang">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/shortcut_env.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/DynaQ.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_27_6.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/shortcut_env_after.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_34_6.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_37_0.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_40_8.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_64_0.png">
<meta property="og:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/output_66_0.png">
<meta property="og:updated_time" content="2020-09-30T08:50:40.877Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dyna-Q and Dyna-Q+">
<meta name="twitter:description" content="Assignment: Dyna-Q and Dyna-Q+Welcome to this programming assignment! In this notebook, you will:  implement the Dyna-Q and Dyna-Q+ algorithms.  compare their performance on an environment which chang">
<meta name="twitter:image" content="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/shortcut_env.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/">





  <title>Dyna-Q and Dyna-Q+ | RUOCHI.AI</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="site-title">RUOCHI.AI</span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            projects
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Dyna-Q-and-Dyna-Q/2020/09/30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Dyna-Q and Dyna-Q+</h2>
        

        <div class="post-meta">
          
          

          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-30T16:50:06+08:00">
                2020-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index">
                    <span itemprop="name">Artificial Intelligence</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/Reinforcement-Learning/" itemprop="url" rel="index">
                    <span itemprop="name">Reinforcement Learning</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Dyna-Q-and-Dyna-Q/2020/09/30/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Dyna-Q-and-Dyna-Q/2020/09/30/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Assignment-Dyna-Q-and-Dyna-Q"><a href="#Assignment-Dyna-Q-and-Dyna-Q" class="headerlink" title="Assignment: Dyna-Q and Dyna-Q+"></a>Assignment: Dyna-Q and Dyna-Q+</h1><p>Welcome to this programming assignment! In this notebook, you will:</p>
<ol>
<li>implement the Dyna-Q and Dyna-Q+ algorithms. </li>
<li>compare their performance on an environment which changes to become ‘better’ than it was before, that is, the task becomes easier. </li>
</ol>
<p>We will give you the environment and infrastructure to run the experiment and visualize the performance. The assignment will be graded automatically by comparing the behavior of your agent to our implementations of the algorithms. The random seed will be set explicitly to avoid different behaviors due to randomness. </p>
<p>Please go through the cells in order. </p>
<h2 id="The-Shortcut-Maze-Environment"><a href="#The-Shortcut-Maze-Environment" class="headerlink" title="The Shortcut Maze Environment"></a>The Shortcut Maze Environment</h2><p>In this maze environment, the goal is to reach the goal state (G) as fast as possible from the starting state (S). There are four actions â€“ up, down, right, left â€“ which take the agent deterministically from a state to the corresponding neighboring states, except when movement is blocked by a wall (denoted by grey) or the edge of the maze, in which case the agent remains where it is. The reward is +1 on reaching the goal state, 0 otherwise. On reaching the goal state G, the agent returns to the start state S to being a new episode. This is a discounted, episodic task with $\gamma = 0.95$.</p>
<p><img src="shortcut_env.png" alt="environment" width="400"></p>
<p>Later in the assignment, we will use a variant of this maze in which a ‘shortcut’ opens up after a certain number of timesteps. We will test if the the Dyna-Q and Dyna-Q+ agents are able to find the newly-opened shorter route to the goal state.</p>
<h2 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h2><p>We import the following libraries that are required for this assignment. Primarily, we shall be using the following libraries:</p>
<ol>
<li>numpy: the fundamental package for scientific computing with Python.</li>
<li>matplotlib: the library for plotting graphs in Python.</li>
<li>RL-Glue: the library for reinforcement learning experiments.</li>
</ol>
<p><strong>Please do not import other libraries</strong> as this will break the autograder.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> jdc</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rl_glue <span class="keyword">import</span> RLGlue</span><br><span class="line"><span class="keyword">from</span> agent <span class="keyword">import</span> BaseAgent</span><br><span class="line"><span class="keyword">from</span> maze_env <span class="keyword">import</span> ShortcutMazeEnvironment</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plt.rcParams.update(&#123;<span class="string">'font.size'</span>: <span class="number">15</span>&#125;)</span><br><span class="line">plt.rcParams.update(&#123;<span class="string">'figure.figsize'</span>: [<span class="number">8</span>,<span class="number">5</span>]&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Section-1-Dyna-Q"><a href="#Section-1-Dyna-Q" class="headerlink" title="Section 1: Dyna-Q"></a>Section 1: Dyna-Q</h2><p>Let’s start with a quick recap of the tabular Dyna-Q algorithm.</p>
<div style="width:80%"><img src="DynaQ.png" alt="DynaQ_pseudocode"></div>

<p>Dyna-Q involves four basic steps:</p>
<ol>
<li>Action selection: given an observation, select an action to be performed (here, using the $\epsilon$-greedy method).</li>
<li>Direct RL: using the observed next state and reward, update the action values (here, using one-step tabular Q-learning).</li>
<li>Model learning: using the observed next state and reward, update the model (here, updating a table as the environment is assumed to be deterministic).</li>
<li>Planning: update the action values by generating $n$ simulated experiences using certain starting states and actions (here, using the random-sample one-step tabular Q-planning method). This is also known as the ‘Indirect RL’ step. The process of choosing the state and action to simulate an experience with is known as ‘search control’.</li>
</ol>
<p>Steps 1 and 2 are parts of the <a href="http://www.incompleteideas.net/book/RLbook2018.pdf#page=153" target="_blank" rel="noopener">tabular Q-learning algorithm</a> and are denoted by line numbers (a)â€“(d) in the pseudocode above. Step 3 is performed in line (e), and Step 4 in the block of lines (f).</p>
<p>We highly recommend revising the Dyna videos in the course and the material in the RL textbook (in particular, <a href="http://www.incompleteideas.net/book/RLbook2018.pdf#page=183" target="_blank" rel="noopener">Section 8.2</a>).</p>
<p>Alright, let’s begin coding.</p>
<p>As you already know by now, you will develop an agent which interacts with the given environment via RL-Glue. More specifically, you will implement the usual methods <code>agent_start</code>, <code>agent_step</code>, and <code>agent_end</code> in your <code>DynaQAgent</code> class, along with a couple of helper methods specific to Dyna-Q, namely <code>update_model</code> and <code>planning_step</code>. We will provide detailed comments in each method describing what your code should do. </p>
<p>Let’s break this down in pieces and do it one-by-one.</p>
<p>First of all, check out the <code>agent_init</code> method below. As in earlier assignments, some of the attributes are initialized with the data passed inside <code>agent_info</code>. In particular, pay attention to the attributes which are new to <code>DynaQAgent</code>, since you shall be using them later. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynaQAgent</span><span class="params">(BaseAgent)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">agent_init</span><span class="params">(self, agent_info)</span>:</span></span><br><span class="line">        <span class="string">"""Setup for the agent called when the experiment first starts.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            agent_init_info (dict), the parameters used to initialize the agent. The dictionary contains:</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                num_states (int): The number of states,</span></span><br><span class="line"><span class="string">                num_actions (int): The number of actions,</span></span><br><span class="line"><span class="string">                epsilon (float): The parameter for epsilon-greedy exploration,</span></span><br><span class="line"><span class="string">                step_size (float): The step-size,</span></span><br><span class="line"><span class="string">                discount (float): The discount factor,</span></span><br><span class="line"><span class="string">                planning_steps (int): The number of planning steps per environmental interaction</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                random_seed (int): the seed for the RNG used in epsilon-greedy</span></span><br><span class="line"><span class="string">                planning_random_seed (int): the seed for the RNG used in the planner</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># First, we get the relevant information from agent_info </span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> we use np.random.RandomState(seed) to set the two different RNGs</span></span><br><span class="line">        <span class="comment"># for the planner and the rest of the code</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.num_states = agent_info[<span class="string">"num_states"</span>]</span><br><span class="line">            self.num_actions = agent_info[<span class="string">"num_actions"</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"You need to pass both 'num_states' and 'num_actions' \</span></span><br><span class="line"><span class="string">                   in agent_info to initialize the action-value table"</span>)</span><br><span class="line">        self.gamma = agent_info.get(<span class="string">"discount"</span>, <span class="number">0.95</span>)</span><br><span class="line">        self.step_size = agent_info.get(<span class="string">"step_size"</span>, <span class="number">0.1</span>)</span><br><span class="line">        self.epsilon = agent_info.get(<span class="string">"epsilon"</span>, <span class="number">0.1</span>)</span><br><span class="line">        self.planning_steps = agent_info.get(<span class="string">"planning_steps"</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        self.rand_generator = np.random.RandomState(agent_info.get(<span class="string">'random_seed'</span>, <span class="number">42</span>))</span><br><span class="line">        self.planning_rand_generator = np.random.RandomState(agent_info.get(<span class="string">'planning_random_seed'</span>, <span class="number">42</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Next, we initialize the attributes required by the agent, e.g., q_values, model, etc.</span></span><br><span class="line">        <span class="comment"># A simple way to implement the model is to have a dictionary of dictionaries, </span></span><br><span class="line">        <span class="comment">#        mapping each state to a dictionary which maps actions to (reward, next state) tuples.</span></span><br><span class="line">        self.q_values = np.zeros((self.num_states, self.num_actions))</span><br><span class="line">        self.actions = list(range(self.num_actions))</span><br><span class="line">        self.past_action = <span class="number">-1</span></span><br><span class="line">        self.past_state = <span class="number">-1</span></span><br><span class="line">        self.model = &#123;&#125; <span class="comment"># model is a dictionary of dictionaries, which maps states to actions to </span></span><br><span class="line">                        <span class="comment"># (reward, next_state) tuples</span></span><br></pre></td></tr></table></figure>
<p>Now let’s create the <code>update_model</code> method, which performs the ‘Model Update’ step in the pseudocode. It takes a <code>(s, a, s&#39;, r)</code> tuple and stores the next state and reward corresponding to a state-action pair.</p>
<p>Remember, because the environment is deterministic, an easy way to implement the model is to have a dictionary of encountered states, each mapping to a dictionary of actions taken in those states, which in turn maps to a tuple of next state and reward. In this way, the model can be easily accessed by <code>model[s][a]</code>, which would return the <code>(s&#39;, r)</code> tuple.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_model</span><span class="params">(self, past_state, past_action, state, reward)</span>:</span></span><br><span class="line">    <span class="string">"""updates the model </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        past_state       (int): s</span></span><br><span class="line"><span class="string">        past_action      (int): a</span></span><br><span class="line"><span class="string">        state            (int): s'</span></span><br><span class="line"><span class="string">        reward           (int): r</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Update the model with the (s,a,s',r) tuple (1~4 lines)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> past_state <span class="keyword">in</span> self.model:</span><br><span class="line">        self.model[past_state] = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> past_action <span class="keyword">in</span> self.model[past_state]:</span><br><span class="line">        self.model[past_state][past_action] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    self.model[past_state][past_action] = (state,reward)</span><br><span class="line">    <span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>
<h3 id="Test-update-model"><a href="#Test-update-model" class="headerlink" title="Test update_model()"></a>Test <code>update_model()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Tested Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># The contents of the cell will be tested by the autograder.</span></span><br><span class="line"><span class="comment"># If they do not pass here, they will not pass there.</span></span><br><span class="line"></span><br><span class="line">actions = []</span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>, </span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (past_state, past_action, state, reward)</span></span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="comment"># action 2 in state 0 leads back to state 0 with a reward of 1</span></span><br><span class="line">    <span class="comment"># or taking action 3 leads to state 1 with reward of 2</span></span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">2</span>: (<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="number">3</span>: (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># taking action 0 in state 2 leads to state 1 with a reward of 1</span></span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br></pre></td></tr></table></figure>
<p>Next, you will implement the planning step, the crux of the Dyna-Q algorithm. You shall be calling this <code>planning_step</code> method at every timestep of every trajectory.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">planning_step</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""performs planning, i.e. indirect RL.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># The indirect RL step:</span></span><br><span class="line">    <span class="comment"># - Choose a state and action from the set of experiences that are stored in the model. (~2 lines)</span></span><br><span class="line">    <span class="comment"># - Query the model with this state-action pair for the predicted next state and reward.(~1 line)</span></span><br><span class="line">    <span class="comment"># - Update the action values with this simulated experience.                            (2~4 lines)</span></span><br><span class="line">    <span class="comment"># - Repeat for the required number of planning steps.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note that the update equation is different for terminal and non-terminal transitions. </span></span><br><span class="line">    <span class="comment"># To differentiate between a terminal and a non-terminal next state, assume that the model stores</span></span><br><span class="line">    <span class="comment"># the terminal state as a dummy state like -1</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Important: remember you have a random number generator 'planning_rand_generator' as </span></span><br><span class="line">    <span class="comment">#     a part of the class which you need to use as self.planning_rand_generator.choice()</span></span><br><span class="line">    <span class="comment">#     For the sake of reproducibility and grading, *do not* use anything else like </span></span><br><span class="line">    <span class="comment">#     np.random.choice() for performing search control.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.planning_steps):</span><br><span class="line">    </span><br><span class="line">        s = self.planning_rand_generator.choice(list(self.model.keys()))</span><br><span class="line">        a = self.planning_rand_generator.choice(list(self.model[s].keys()))</span><br><span class="line"></span><br><span class="line">        (next_s,r) = self.model[s][a]</span><br><span class="line">        <span class="keyword">if</span> next_s == <span class="number">-1</span>:</span><br><span class="line">            expect = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            expect = self.gamma * np.max(self.q_values[next_s])</span><br><span class="line">        self.q_values[s,a] += self.step_size * (r + expect - self.q_values[s,a])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>
<h3 id="Test-planning-step"><a href="#Test-planning-step" class="headerlink" title="Test planning_step()"></a>Test <code>planning_step()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Tested Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># The contents of the cell will be tested by the autograder.</span></span><br><span class="line"><span class="comment"># If they do not pass here, they will not pass there.</span></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">actions = []</span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>, </span><br><span class="line">              <span class="string">"planning_steps"</span>: <span class="number">4</span>,</span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">2</span>: (<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="number">3</span>: (<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="number">1</span>: (<span class="number">-1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br><span class="line"></span><br><span class="line">agent.planning_step()</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0.2</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.all(np.isclose(agent.q_values, expected_values))</span><br></pre></td></tr></table></figure>
<p>Now before you move on to implement the rest of the agent methods, here are the helper functions that you’ve used in the previous assessments for choosing an action using an $\epsilon$-greedy policy.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">argmax</span><span class="params">(self, q_values)</span>:</span></span><br><span class="line">    <span class="string">"""argmax with random tie-breaking</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        q_values (Numpy array): the array of action values</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        action (int): an action with the highest value</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    top = float(<span class="string">"-inf"</span>)</span><br><span class="line">    ties = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(q_values)):</span><br><span class="line">        <span class="keyword">if</span> q_values[i] &gt; top:</span><br><span class="line">            top = q_values[i]</span><br><span class="line">            ties = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> q_values[i] == top:</span><br><span class="line">            ties.append(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.rand_generator.choice(ties)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose_action_egreedy</span><span class="params">(self, state)</span>:</span></span><br><span class="line">    <span class="string">"""returns an action using an epsilon-greedy policy w.r.t. the current action-value function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Important: assume you have a random number generator 'rand_generator' as a part of the class</span></span><br><span class="line"><span class="string">                which you can use as self.rand_generator.choice() or self.rand_generator.rand()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        state (List): coordinates of the agent (two elements)</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        The action taken w.r.t. the aforementioned epsilon-greedy policy</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.rand_generator.rand() &lt; self.epsilon:</span><br><span class="line">        action = self.rand_generator.choice(self.actions)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        values = self.q_values[state]</span><br><span class="line">        action = self.argmax(values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br></pre></td></tr></table></figure>
<p>Next, you will implement the rest of the agent-related methods, namely <code>agent_start</code>, <code>agent_step</code>, and <code>agent_end</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_start</span><span class="params">(self, state)</span>:</span></span><br><span class="line">    <span class="string">"""The first method called when the experiment starts, </span></span><br><span class="line"><span class="string">    called after the environment starts.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        state (Numpy array): the state from the</span></span><br><span class="line"><span class="string">            environment's env_start function.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (int) the first action the agent takes.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># given the state, select the action using self.choose_action_egreedy()), </span></span><br><span class="line">    <span class="comment"># and save current state and action (~2 lines)</span></span><br><span class="line">    <span class="comment">### self.past_state = ?</span></span><br><span class="line">    <span class="comment">### self.past_action = ?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.past_state = state</span><br><span class="line">    self.past_action = self.choose_action_egreedy(state)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> self.past_action</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_step</span><span class="params">(self, reward, state)</span>:</span></span><br><span class="line">    <span class="string">"""A step taken by the agent.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        reward (float): the reward received for taking the last action taken</span></span><br><span class="line"><span class="string">        state (Numpy array): the state from the</span></span><br><span class="line"><span class="string">            environment's step based on where the agent ended up after the</span></span><br><span class="line"><span class="string">            last step</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (int) The action the agent takes given this state.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># - Direct-RL step (~1-3 lines)</span></span><br><span class="line">    <span class="comment"># - Model Update step (~1 line)</span></span><br><span class="line">    <span class="comment"># - `planning_step` (~1 line)</span></span><br><span class="line">    <span class="comment"># - Action Selection step (~1 line)</span></span><br><span class="line">    <span class="comment"># Save the current state and action before returning the action to be performed. (~2 lines)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.q_values[self.past_state,self.past_action] += self.step_size * (reward + self.gamma * np.max(self.q_values[state]) - self.q_values[self.past_state,self.past_action])</span><br><span class="line">    self.update_model(self.past_state, self.past_action, state, reward)</span><br><span class="line">    self.planning_step()</span><br><span class="line">    </span><br><span class="line">    action = self.choose_action_egreedy(state)</span><br><span class="line">    self.past_state = state</span><br><span class="line">    self.past_action = action</span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> self.past_action</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_end</span><span class="params">(self, reward)</span>:</span></span><br><span class="line">    <span class="string">"""Called when the agent terminates.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        reward (float): the reward the agent received for entering the</span></span><br><span class="line"><span class="string">            terminal state.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># - Direct RL update with this final transition (1~2 lines)</span></span><br><span class="line">    <span class="comment"># - Model Update step with this final transition (~1 line)</span></span><br><span class="line">    <span class="comment"># - One final `planning_step` (~1 line)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note: the final transition needs to be handled carefully. Since there is no next state, </span></span><br><span class="line">    <span class="comment">#       you will have to pass a dummy state (like -1), which you will be using in the planning_step() to </span></span><br><span class="line">    <span class="comment">#       differentiate between updates with usual terminal and non-terminal transitions.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.q_values[self.past_state,self.past_action] += self.step_size * (reward  - self.q_values[self.past_state,self.past_action])</span><br><span class="line">    self.update_model(self.past_state, self.past_action, <span class="number">-1</span>, reward)</span><br><span class="line">    self.planning_step()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>
<h3 id="Test-agent-start-agent-step-and-agent-end"><a href="#Test-agent-start-agent-step-and-agent-end" class="headerlink" title="Test agent_start(), agent_step(), and agent_end()"></a>Test <code>agent_start()</code>, <code>agent_step()</code>, and <code>agent_end()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Tested Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># The contents of the cell will be tested by the autograder.</span></span><br><span class="line"><span class="comment"># If they do not pass here, they will not pass there.</span></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>, </span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_steps"</span>: <span class="number">2</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------</span></span><br><span class="line"><span class="comment"># test agent start</span></span><br><span class="line"><span class="comment"># ----------------</span></span><br><span class="line"></span><br><span class="line">action = agent.agent_start(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> agent.model == &#123;&#125;</span><br><span class="line"><span class="keyword">assert</span> np.all(agent.q_values == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># test agent step</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line">action = agent.agent_step(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">3</span></span><br><span class="line"></span><br><span class="line">action = agent.agent_step(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">3</span>: (<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.3439</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, expected_values)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"><span class="comment"># test agent end</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"></span><br><span class="line">agent.agent_end(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">3</span>: (<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">        <span class="number">1</span>: (<span class="number">-1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.41051</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.01</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, expected_values)</span><br></pre></td></tr></table></figure>
<h3 id="Experiment-Dyna-Q-agent-in-the-maze-environment"><a href="#Experiment-Dyna-Q-agent-in-the-maze-environment" class="headerlink" title="Experiment: Dyna-Q agent in the maze environment"></a>Experiment: Dyna-Q agent in the maze environment</h3><p>Alright. Now we have all the components of the <code>DynaQAgent</code> ready. Let’s try it out on the maze environment! </p>
<p>The next cell runs an experiment on this maze environment to test your implementation. The initial action values are $0$, the step-size parameter is $0.125$. and the exploration parameter is $\epsilon=0.1$. After the experiment, the sum of rewards in each episode should match the correct result.</p>
<p>We will try planning steps of $0,5,50$ and compare their performance in terms of the average number of steps taken to reach the goal state in the aforementioned maze environment. For scientific rigor, we will run each experiment $30$ times. In each experiment, we set the initial random-number-generator (RNG) seeds for a fair comparison across algorithms.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_experiment</span><span class="params">(env, agent, env_parameters, agent_parameters, exp_parameters)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Experiment settings</span></span><br><span class="line">    num_runs = exp_parameters[<span class="string">'num_runs'</span>]</span><br><span class="line">    num_episodes = exp_parameters[<span class="string">'num_episodes'</span>]</span><br><span class="line">    planning_steps_all = agent_parameters[<span class="string">'planning_steps'</span>]</span><br><span class="line"></span><br><span class="line">    env_info = env_parameters                     </span><br><span class="line">    agent_info = &#123;<span class="string">"num_states"</span> : agent_parameters[<span class="string">"num_states"</span>],  <span class="comment"># We pass the agent the information it needs. </span></span><br><span class="line">                  <span class="string">"num_actions"</span> : agent_parameters[<span class="string">"num_actions"</span>],</span><br><span class="line">                  <span class="string">"epsilon"</span>: agent_parameters[<span class="string">"epsilon"</span>], </span><br><span class="line">                  <span class="string">"discount"</span>: env_parameters[<span class="string">"discount"</span>],</span><br><span class="line">                  <span class="string">"step_size"</span> : agent_parameters[<span class="string">"step_size"</span>]&#125;</span><br><span class="line"></span><br><span class="line">    all_averages = np.zeros((len(planning_steps_all), num_runs, num_episodes)) <span class="comment"># for collecting metrics </span></span><br><span class="line">    log_data = &#123;<span class="string">'planning_steps_all'</span> : planning_steps_all&#125;                     <span class="comment"># that shall be plotted later</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, planning_steps <span class="keyword">in</span> enumerate(planning_steps_all):</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Planning steps : '</span>, planning_steps)</span><br><span class="line">        os.system(<span class="string">'sleep 0.5'</span>)                    <span class="comment"># to prevent tqdm printing out-of-order before the above print()</span></span><br><span class="line">        agent_info[<span class="string">"planning_steps"</span>] = planning_steps  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(range(num_runs)):</span><br><span class="line"></span><br><span class="line">            agent_info[<span class="string">'random_seed'</span>] = i</span><br><span class="line">            agent_info[<span class="string">'planning_random_seed'</span>] = i</span><br><span class="line"></span><br><span class="line">            rl_glue = RLGlue(env, agent)          <span class="comment"># Creates a new RLGlue experiment with the env and agent we chose above</span></span><br><span class="line">            rl_glue.rl_init(agent_info, env_info) <span class="comment"># We pass RLGlue what it needs to initialize the agent and environment</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(num_episodes):</span><br><span class="line"></span><br><span class="line">                rl_glue.rl_start()                <span class="comment"># We start an episode. Here we aren't using rl_glue.rl_episode()</span></span><br><span class="line">                                                  <span class="comment"># like the other assessments because we'll be requiring some </span></span><br><span class="line">                is_terminal = <span class="keyword">False</span>               <span class="comment"># data from within the episodes in some of the experiments here </span></span><br><span class="line">                num_steps = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> <span class="keyword">not</span> is_terminal:</span><br><span class="line">                    reward, _, action, is_terminal = rl_glue.rl_step()  <span class="comment"># The environment and agent take a step </span></span><br><span class="line">                    num_steps += <span class="number">1</span>                                      <span class="comment"># and return the reward and action taken.</span></span><br><span class="line"></span><br><span class="line">                all_averages[idx][i][j] = num_steps</span><br><span class="line"></span><br><span class="line">    log_data[<span class="string">'all_averages'</span>] = all_averages</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> log_data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_steps_per_episode</span><span class="params">(data)</span>:</span></span><br><span class="line">    all_averages = data[<span class="string">'all_averages'</span>]</span><br><span class="line">    planning_steps_all = data[<span class="string">'planning_steps_all'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, planning_steps <span class="keyword">in</span> enumerate(planning_steps_all):</span><br><span class="line">        plt.plot(np.mean(all_averages[i], axis=<span class="number">0</span>), label=<span class="string">'Planning steps = '</span>+str(planning_steps))</span><br><span class="line"></span><br><span class="line">    plt.legend(loc=<span class="string">'upper right'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Episodes'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Steps\nper\nepisode'</span>, rotation=<span class="number">0</span>, labelpad=<span class="number">40</span>)</span><br><span class="line">    plt.axhline(y=<span class="number">16</span>, linestyle=<span class="string">'--'</span>, color=<span class="string">'grey'</span>, alpha=<span class="number">0.4</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Experiment parameters</span></span><br><span class="line">experiment_parameters = &#123;</span><br><span class="line">    <span class="string">"num_runs"</span> : <span class="number">30</span>,                     <span class="comment"># The number of times we run the experiment</span></span><br><span class="line">    <span class="string">"num_episodes"</span> : <span class="number">40</span>,                 <span class="comment"># The number of episodes per experiment</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment parameters</span></span><br><span class="line">environment_parameters = &#123; </span><br><span class="line">    <span class="string">"discount"</span>: <span class="number">0.95</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent parameters</span></span><br><span class="line">agent_parameters = &#123;  </span><br><span class="line">    <span class="string">"num_states"</span> : <span class="number">54</span>,</span><br><span class="line">    <span class="string">"num_actions"</span> : <span class="number">4</span>, </span><br><span class="line">    <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">    <span class="string">"step_size"</span> : <span class="number">0.125</span>,</span><br><span class="line">    <span class="string">"planning_steps"</span> : [<span class="number">0</span>, <span class="number">5</span>, <span class="number">50</span>]       <span class="comment"># The list of planning_steps we want to try</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">current_env = ShortcutMazeEnvironment   <span class="comment"># The environment</span></span><br><span class="line">current_agent = DynaQAgent              <span class="comment"># The agent</span></span><br><span class="line"></span><br><span class="line">dataq = run_experiment(current_env, current_agent, environment_parameters, agent_parameters, experiment_parameters)</span><br><span class="line">plot_steps_per_episode(dataq)</span><br></pre></td></tr></table></figure>
<pre><code>Planning steps :  0


100%|██████████| 30/30 [00:07&lt;00:00,  3.97it/s]


Planning steps :  5


100%|██████████| 30/30 [00:09&lt;00:00,  3.24it/s]


Planning steps :  50


100%|██████████| 30/30 [00:53&lt;00:00,  1.79s/it]
</code></pre><p><img src="output_27_6.png" alt="png"></p>
<p>What do you notice?</p>
<p>As the number of planning steps increases, the number of episodes taken to reach the goal decreases rapidly. Remember that the RNG seed was set the same for all the three values of planning steps, resulting in the same number of steps taken to reach the goal in the first episode. Thereafter, the performance improves. The slowest improvement is when there are $n=0$ planning steps, i.e., for the non-planning Q-learning agent, even though the step size parameter was optimized for it. Note that the grey dotted line shows the minimum number of steps required to reach the goal state under the optimal greedy policy.</p>
<hr>
<h3 id="Experiment-s-Dyna-Q-agent-in-the-changing-maze-environment"><a href="#Experiment-s-Dyna-Q-agent-in-the-changing-maze-environment" class="headerlink" title="Experiment(s): Dyna-Q agent in the _changing_ maze environment"></a>Experiment(s): Dyna-Q agent in the _changing_ maze environment</h3><p>Great! Now let us see how Dyna-Q performs on the version of the maze in which a shorter path opens up after 3000 steps. The rest of the transition and reward dynamics remain the same. </p>
<p><img src="shortcut_env_after.png" alt="environment" width="800"></p>
<p>Before you proceed, take a moment to think about what you expect to see. Will Dyna-Q find the new, shorter path to the goal? If so, why? If not, why not?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_experiment_with_state_visitations</span><span class="params">(env, agent, env_parameters, agent_parameters, exp_parameters, result_file_name)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Experiment settings</span></span><br><span class="line">    num_runs = exp_parameters[<span class="string">'num_runs'</span>]</span><br><span class="line">    num_max_steps = exp_parameters[<span class="string">'num_max_steps'</span>]</span><br><span class="line">    planning_steps_all = agent_parameters[<span class="string">'planning_steps'</span>]</span><br><span class="line"></span><br><span class="line">    env_info = &#123;<span class="string">"change_at_n"</span> : env_parameters[<span class="string">"change_at_n"</span>]&#125;                     </span><br><span class="line">    agent_info = &#123;<span class="string">"num_states"</span> : agent_parameters[<span class="string">"num_states"</span>],  </span><br><span class="line">                  <span class="string">"num_actions"</span> : agent_parameters[<span class="string">"num_actions"</span>],</span><br><span class="line">                  <span class="string">"epsilon"</span>: agent_parameters[<span class="string">"epsilon"</span>], </span><br><span class="line">                  <span class="string">"discount"</span>: env_parameters[<span class="string">"discount"</span>],</span><br><span class="line">                  <span class="string">"step_size"</span> : agent_parameters[<span class="string">"step_size"</span>]&#125;</span><br><span class="line"></span><br><span class="line">    state_visits_before_change = np.zeros((len(planning_steps_all), num_runs, <span class="number">54</span>))  <span class="comment"># For saving the number of</span></span><br><span class="line">    state_visits_after_change = np.zeros((len(planning_steps_all), num_runs, <span class="number">54</span>))   <span class="comment">#     state-visitations </span></span><br><span class="line">    cum_reward_all = np.zeros((len(planning_steps_all), num_runs, num_max_steps))   <span class="comment"># For saving the cumulative reward</span></span><br><span class="line">    log_data = &#123;<span class="string">'planning_steps_all'</span> : planning_steps_all&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, planning_steps <span class="keyword">in</span> enumerate(planning_steps_all):</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Planning steps : '</span>, planning_steps)</span><br><span class="line">        os.system(<span class="string">'sleep 1'</span>)          <span class="comment"># to prevent tqdm printing out-of-order before the above print()</span></span><br><span class="line">        agent_info[<span class="string">"planning_steps"</span>] = planning_steps  <span class="comment"># We pass the agent the information it needs. </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> run <span class="keyword">in</span> tqdm(range(num_runs)):</span><br><span class="line"></span><br><span class="line">            agent_info[<span class="string">'random_seed'</span>] = run</span><br><span class="line">            agent_info[<span class="string">'planning_random_seed'</span>] = run</span><br><span class="line"></span><br><span class="line">            rl_glue = RLGlue(env, agent)  <span class="comment"># Creates a new RLGlue experiment with the env and agent we chose above</span></span><br><span class="line">            rl_glue.rl_init(agent_info, env_info) <span class="comment"># We pass RLGlue what it needs to initialize the agent and environment</span></span><br><span class="line"></span><br><span class="line">            num_steps = <span class="number">0</span></span><br><span class="line">            cum_reward = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> num_steps &lt; num_max_steps<span class="number">-1</span> :</span><br><span class="line"></span><br><span class="line">                state, _ = rl_glue.rl_start()  <span class="comment"># We start the experiment. We'll be collecting the </span></span><br><span class="line">                is_terminal = <span class="keyword">False</span>            <span class="comment"># state-visitation counts to visiualize the learned policy</span></span><br><span class="line">                <span class="keyword">if</span> num_steps &lt; env_parameters[<span class="string">"change_at_n"</span>]: </span><br><span class="line">                    state_visits_before_change[idx][run][state] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    state_visits_after_change[idx][run][state] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> <span class="keyword">not</span> is_terminal <span class="keyword">and</span> num_steps &lt; num_max_steps<span class="number">-1</span> :</span><br><span class="line">                    reward, state, action, is_terminal = rl_glue.rl_step()  </span><br><span class="line">                    num_steps += <span class="number">1</span></span><br><span class="line">                    cum_reward += reward</span><br><span class="line">                    cum_reward_all[idx][run][num_steps] = cum_reward</span><br><span class="line">                    <span class="keyword">if</span> num_steps &lt; env_parameters[<span class="string">"change_at_n"</span>]:</span><br><span class="line">                        state_visits_before_change[idx][run][state] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        state_visits_after_change[idx][run][state] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    log_data[<span class="string">'state_visits_before'</span>] = state_visits_before_change</span><br><span class="line">    log_data[<span class="string">'state_visits_after'</span>] = state_visits_after_change</span><br><span class="line">    log_data[<span class="string">'cum_reward_all'</span>] = cum_reward_all</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> log_data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_cumulative_reward</span><span class="params">(data_all, item_key, y_key, y_axis_label, legend_prefix, title)</span>:</span></span><br><span class="line">    data_y_all = data_all[y_key]</span><br><span class="line">    items = data_all[item_key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, item <span class="keyword">in</span> enumerate(items):</span><br><span class="line">        plt.plot(np.mean(data_y_all[i], axis=<span class="number">0</span>), label=legend_prefix+str(item))</span><br><span class="line"></span><br><span class="line">    plt.axvline(x=<span class="number">3000</span>, linestyle=<span class="string">'--'</span>, color=<span class="string">'grey'</span>, alpha=<span class="number">0.4</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Timesteps'</span>)</span><br><span class="line">    plt.ylabel(y_axis_label, rotation=<span class="number">0</span>, labelpad=<span class="number">60</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.title(title)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p>Did you notice that the environment changes after a fixed number of _steps_ and not episodes? </p>
<p>This is because the environment is separate from the agent, and the environment changes irrespective of the length of each episode (i.e., the number of environmental interactions per episode) that the agent perceives. And hence we are now plotting the data per step or interaction of the agent and the environment, in order to comfortably see the differences in the behaviours of the agents before and after the environment changes.  </p>
<p>Okay, now we will first plot the cumulative reward obtained by the agent per interaction with the environment, averaged over 10 runs of the experiment on this changing world. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Experiment parameters</span></span><br><span class="line">experiment_parameters = &#123;</span><br><span class="line">    <span class="string">"num_runs"</span> : <span class="number">10</span>,                     <span class="comment"># The number of times we run the experiment</span></span><br><span class="line">    <span class="string">"num_max_steps"</span> : <span class="number">6000</span>,              <span class="comment"># The number of steps per experiment</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment parameters</span></span><br><span class="line">environment_parameters = &#123; </span><br><span class="line">    <span class="string">"discount"</span>: <span class="number">0.95</span>,</span><br><span class="line">    <span class="string">"change_at_n"</span>: <span class="number">3000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent parameters</span></span><br><span class="line">agent_parameters = &#123;  </span><br><span class="line">    <span class="string">"num_states"</span> : <span class="number">54</span>,</span><br><span class="line">    <span class="string">"num_actions"</span> : <span class="number">4</span>, </span><br><span class="line">    <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">    <span class="string">"step_size"</span> : <span class="number">0.125</span>,</span><br><span class="line">    <span class="string">"planning_steps"</span> : [<span class="number">5</span>, <span class="number">10</span>, <span class="number">50</span>]      <span class="comment"># The list of planning_steps we want to try</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">current_env = ShortcutMazeEnvironment   <span class="comment"># The environment</span></span><br><span class="line">current_agent = DynaQAgent              <span class="comment"># The agent</span></span><br><span class="line"></span><br><span class="line">dataq = run_experiment_with_state_visitations(current_env, current_agent, environment_parameters, agent_parameters, experiment_parameters, <span class="string">"Dyna-Q_shortcut_steps"</span>)    </span><br><span class="line">plot_cumulative_reward(dataq, <span class="string">'planning_steps_all'</span>, <span class="string">'cum_reward_all'</span>, <span class="string">'Cumulative\nreward'</span>, <span class="string">'Planning steps = '</span>, <span class="string">'Dyna-Q : Varying planning_steps'</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Planning steps :  5


100%|██████████| 10/10 [00:10&lt;00:00,  1.08s/it]


Planning steps :  10


100%|██████████| 10/10 [00:16&lt;00:00,  1.70s/it]


Planning steps :  50


100%|██████████| 10/10 [01:19&lt;00:00,  7.99s/it]
</code></pre><p><img src="output_34_6.png" alt="png"></p>
<p>We observe that the slope of the curves is almost constant. If the agent had discovered the shortcut and begun using it, we would expect to see an increase in the slope of the curves towards the later stages of training. This is because the agent can get to the goal state faster and get the positive reward. Note that the timestep at which the shortcut opens up is marked by the grey dotted line.</p>
<p>Note that this trend is constant across the increasing number of planning steps.</p>
<p>Now let’s check the heatmap of the state visitations of the agent with <code>planning_steps=10</code> during training, before and after the shortcut opens up after 3000 timesteps.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_state_visitations</span><span class="params">(data, plot_titles, idx)</span>:</span></span><br><span class="line">    data_keys = [<span class="string">"state_visits_before"</span>, <span class="string">"state_visits_after"</span>]</span><br><span class="line">    positions = [<span class="number">211</span>,<span class="number">212</span>]</span><br><span class="line">    titles = plot_titles</span><br><span class="line">    wall_ends = [<span class="keyword">None</span>,<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line"></span><br><span class="line">        state_visits = data[data_keys[i]][idx]</span><br><span class="line">        average_state_visits = np.mean(state_visits, axis=<span class="number">0</span>)</span><br><span class="line">        grid_state_visits = np.rot90(average_state_visits.reshape((<span class="number">6</span>,<span class="number">9</span>)).T)</span><br><span class="line">        grid_state_visits[<span class="number">2</span>,<span class="number">1</span>:wall_ends[i]] = np.nan <span class="comment"># walls</span></span><br><span class="line">        <span class="comment">#print(average_state_visits.reshape((6,9)))</span></span><br><span class="line">        plt.subplot(positions[i])</span><br><span class="line">        plt.pcolormesh(grid_state_visits, edgecolors=<span class="string">'gray'</span>, linewidth=<span class="number">1</span>, cmap=<span class="string">'viridis'</span>)</span><br><span class="line">        plt.text(<span class="number">3</span>+<span class="number">0.5</span>, <span class="number">0</span>+<span class="number">0.5</span>, <span class="string">'S'</span>, horizontalalignment=<span class="string">'center'</span>, verticalalignment=<span class="string">'center'</span>)</span><br><span class="line">        plt.text(<span class="number">8</span>+<span class="number">0.5</span>, <span class="number">5</span>+<span class="number">0.5</span>, <span class="string">'G'</span>, horizontalalignment=<span class="string">'center'</span>, verticalalignment=<span class="string">'center'</span>)</span><br><span class="line">        plt.title(titles[i])</span><br><span class="line">        plt.axis(<span class="string">'off'</span>)</span><br><span class="line">        cm = plt.get_cmap()</span><br><span class="line">        cm.set_bad(<span class="string">'gray'</span>)</span><br><span class="line"></span><br><span class="line">    plt.subplots_adjust(bottom=<span class="number">0.0</span>, right=<span class="number">0.7</span>, top=<span class="number">1.0</span>)</span><br><span class="line">    cax = plt.axes([<span class="number">1.</span>, <span class="number">0.0</span>, <span class="number">0.075</span>, <span class="number">1.</span>])</span><br><span class="line">    cbar = plt.colorbar(cax=cax)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do not modify this cell!</span></span><br><span class="line"></span><br><span class="line">plot_state_visitations(dataq, [<span class="string">'Dyna-Q : State visitations before the env changes'</span>, <span class="string">'Dyna-Q : State visitations after the env changes'</span>], <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><img src="output_37_0.png" alt="png"></p>
<p>What do you observe?</p>
<p>The state visitation map looks almost the same before and after the shortcut opens. This means that the Dyna-Q agent hasn’t quite discovered and started exploiting the new shortcut.</p>
<p>Now let’s try increasing the exploration parameter $\epsilon$ to see if it helps the Dyna-Q agent discover the shortcut. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_experiment_only_cumulative_reward</span><span class="params">(env, agent, env_parameters, agent_parameters, exp_parameters)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Experiment settings</span></span><br><span class="line">    num_runs = exp_parameters[<span class="string">'num_runs'</span>]</span><br><span class="line">    num_max_steps = exp_parameters[<span class="string">'num_max_steps'</span>]</span><br><span class="line">    epsilons = agent_parameters[<span class="string">'epsilons'</span>]</span><br><span class="line"></span><br><span class="line">    env_info = &#123;<span class="string">"change_at_n"</span> : env_parameters[<span class="string">"change_at_n"</span>]&#125;                     </span><br><span class="line">    agent_info = &#123;<span class="string">"num_states"</span> : agent_parameters[<span class="string">"num_states"</span>],  </span><br><span class="line">                  <span class="string">"num_actions"</span> : agent_parameters[<span class="string">"num_actions"</span>],</span><br><span class="line">                  <span class="string">"planning_steps"</span>: agent_parameters[<span class="string">"planning_steps"</span>], </span><br><span class="line">                  <span class="string">"discount"</span>: env_parameters[<span class="string">"discount"</span>],</span><br><span class="line">                  <span class="string">"step_size"</span> : agent_parameters[<span class="string">"step_size"</span>]&#125;</span><br><span class="line"></span><br><span class="line">    log_data = &#123;<span class="string">'epsilons'</span> : epsilons&#125; </span><br><span class="line">    cum_reward_all = np.zeros((len(epsilons), num_runs, num_max_steps))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> eps_idx, epsilon <span class="keyword">in</span> enumerate(epsilons):</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Agent : Dyna-Q, epsilon : %f'</span> % epsilon)</span><br><span class="line">        os.system(<span class="string">'sleep 1'</span>)          <span class="comment"># to prevent tqdm printing out-of-order before the above print()</span></span><br><span class="line">        agent_info[<span class="string">"epsilon"</span>] = epsilon</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> run <span class="keyword">in</span> tqdm(range(num_runs)):</span><br><span class="line"></span><br><span class="line">            agent_info[<span class="string">'random_seed'</span>] = run</span><br><span class="line">            agent_info[<span class="string">'planning_random_seed'</span>] = run</span><br><span class="line"></span><br><span class="line">            rl_glue = RLGlue(env, agent)  <span class="comment"># Creates a new RLGlue experiment with the env and agent we chose above</span></span><br><span class="line">            rl_glue.rl_init(agent_info, env_info) <span class="comment"># We pass RLGlue what it needs to initialize the agent and environment</span></span><br><span class="line"></span><br><span class="line">            num_steps = <span class="number">0</span></span><br><span class="line">            cum_reward = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> num_steps &lt; num_max_steps<span class="number">-1</span> :</span><br><span class="line"></span><br><span class="line">                rl_glue.rl_start()  <span class="comment"># We start the experiment</span></span><br><span class="line">                is_terminal = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> <span class="keyword">not</span> is_terminal <span class="keyword">and</span> num_steps &lt; num_max_steps<span class="number">-1</span> :</span><br><span class="line">                    reward, _, action, is_terminal = rl_glue.rl_step()  <span class="comment"># The environment and agent take a step and return</span></span><br><span class="line">                    <span class="comment"># the reward, and action taken.</span></span><br><span class="line">                    num_steps += <span class="number">1</span></span><br><span class="line">                    cum_reward += reward</span><br><span class="line">                    cum_reward_all[eps_idx][run][num_steps] = cum_reward</span><br><span class="line"></span><br><span class="line">    log_data[<span class="string">'cum_reward_all'</span>] = cum_reward_all</span><br><span class="line">    <span class="keyword">return</span> log_data</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Experiment parameters</span></span><br><span class="line">experiment_parameters = &#123;</span><br><span class="line">    <span class="string">"num_runs"</span> : <span class="number">30</span>,                     <span class="comment"># The number of times we run the experiment</span></span><br><span class="line">    <span class="string">"num_max_steps"</span> : <span class="number">6000</span>,              <span class="comment"># The number of steps per experiment</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment parameters</span></span><br><span class="line">environment_parameters = &#123; </span><br><span class="line">    <span class="string">"discount"</span>: <span class="number">0.95</span>,</span><br><span class="line">    <span class="string">"change_at_n"</span>: <span class="number">3000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent parameters</span></span><br><span class="line">agent_parameters = &#123;  </span><br><span class="line">    <span class="string">"num_states"</span> : <span class="number">54</span>,</span><br><span class="line">    <span class="string">"num_actions"</span> : <span class="number">4</span>, </span><br><span class="line">    <span class="string">"step_size"</span> : <span class="number">0.125</span>,</span><br><span class="line">    <span class="string">"planning_steps"</span> : <span class="number">10</span>,</span><br><span class="line">    <span class="string">"epsilons"</span>: [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.4</span>, <span class="number">0.8</span>]    <span class="comment"># The list of epsilons we want to try</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">current_env = ShortcutMazeEnvironment   <span class="comment"># The environment</span></span><br><span class="line">current_agent = DynaQAgent              <span class="comment"># The agent</span></span><br><span class="line"></span><br><span class="line">data = run_experiment_only_cumulative_reward(current_env, current_agent, environment_parameters, agent_parameters, experiment_parameters)</span><br><span class="line">plot_cumulative_reward(data, <span class="string">'epsilons'</span>, <span class="string">'cum_reward_all'</span>, <span class="string">'Cumulative\nreward'</span>, <span class="string">r'$\epsilon$ = '</span>, <span class="string">r'Dyna-Q : Varying $\epsilon$'</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Agent : Dyna-Q, epsilon : 0.100000


100%|██████████| 30/30 [00:52&lt;00:00,  1.75s/it]


Agent : Dyna-Q, epsilon : 0.200000


100%|██████████| 30/30 [00:49&lt;00:00,  1.65s/it]


Agent : Dyna-Q, epsilon : 0.400000


100%|██████████| 30/30 [00:50&lt;00:00,  1.69s/it]


Agent : Dyna-Q, epsilon : 0.800000


100%|██████████| 30/30 [00:52&lt;00:00,  1.74s/it]
</code></pre><p><img src="output_40_8.png" alt="png"></p>
<p>What do you observe?</p>
<p>Increasing the exploration via the $\epsilon$-greedy strategy does not seem to be helping. In fact, the agent’s cumulative reward decreases because it is spending more and more time trying out the exploratory actions.</p>
<p>Can we do better…? </p>
<h2 id="Section-2-Dyna-Q"><a href="#Section-2-Dyna-Q" class="headerlink" title="Section 2: Dyna-Q+"></a>Section 2: Dyna-Q+</h2><p>The motivation behind Dyna-Q+ is to give a bonus reward for actions that haven’t been tried for a long time, since there is a greater chance that the dynamics for that actions might have changed.</p>
<p>In particular, if the modeled reward for a transition is $r$, and the transition has not been tried in $\tau(s,a)$ time steps, then planning updates are done as if that transition produced a reward of $r + \kappa \sqrt{ \tau(s,a)}$, for some small $\kappa$. </p>
<p>Let’s implement that!</p>
<p>Based on your <code>DynaQAgent</code>, create a new class <code>DynaQPlusAgent</code> to implement the aforementioned exploration heuristic. Additionally :</p>
<ol>
<li>actions that had never been tried before from a state should now be allowed to be considered in the planning step,</li>
<li>and the initial model for such actions is that they lead back to the same state with a reward of zero.</li>
</ol>
<p>At this point, you might want to refer to the video lectures and <a href="http://www.incompleteideas.net/book/RLbook2018.pdf#page=188" target="_blank" rel="noopener">Section 8.3</a> of the RL textbook for a refresher on Dyna-Q+.</p>
<p>As usual, let’s break this down in pieces and do it one-by-one.</p>
<p>First of all, check out the <code>agent_init</code> method below. In particular, pay attention to the attributes which are new to <code>DynaQPlusAgent</code>â€“ state-visitation counts $\tau$ and the scaling parameter $\kappa$ â€“ because you shall be using them later. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynaQPlusAgent</span><span class="params">(BaseAgent)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">agent_init</span><span class="params">(self, agent_info)</span>:</span></span><br><span class="line">        <span class="string">"""Setup for the agent called when the experiment first starts.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            agent_init_info (dict), the parameters used to initialize the agent. The dictionary contains:</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                num_states (int): The number of states,</span></span><br><span class="line"><span class="string">                num_actions (int): The number of actions,</span></span><br><span class="line"><span class="string">                epsilon (float): The parameter for epsilon-greedy exploration,</span></span><br><span class="line"><span class="string">                step_size (float): The step-size,</span></span><br><span class="line"><span class="string">                discount (float): The discount factor,</span></span><br><span class="line"><span class="string">                planning_steps (int): The number of planning steps per environmental interaction</span></span><br><span class="line"><span class="string">                kappa (float): The scaling factor for the reward bonus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                random_seed (int): the seed for the RNG used in epsilon-greedy</span></span><br><span class="line"><span class="string">                planning_random_seed (int): the seed for the RNG used in the planner</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># First, we get the relevant information from agent_info </span></span><br><span class="line">        <span class="comment"># Note: we use np.random.RandomState(seed) to set the two different RNGs</span></span><br><span class="line">        <span class="comment"># for the planner and the rest of the code</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.num_states = agent_info[<span class="string">"num_states"</span>]</span><br><span class="line">            self.num_actions = agent_info[<span class="string">"num_actions"</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"You need to pass both 'num_states' and 'num_actions' \</span></span><br><span class="line"><span class="string">                   in agent_info to initialize the action-value table"</span>)</span><br><span class="line">        self.gamma = agent_info.get(<span class="string">"discount"</span>, <span class="number">0.95</span>)</span><br><span class="line">        self.step_size = agent_info.get(<span class="string">"step_size"</span>, <span class="number">0.1</span>)</span><br><span class="line">        self.epsilon = agent_info.get(<span class="string">"epsilon"</span>, <span class="number">0.1</span>)</span><br><span class="line">        self.planning_steps = agent_info.get(<span class="string">"planning_steps"</span>, <span class="number">10</span>)</span><br><span class="line">        self.kappa = agent_info.get(<span class="string">"kappa"</span>, <span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">        self.rand_generator = np.random.RandomState(agent_info.get(<span class="string">'random_seed'</span>, <span class="number">42</span>))</span><br><span class="line">        self.planning_rand_generator = np.random.RandomState(agent_info.get(<span class="string">'planning_random_seed'</span>, <span class="number">42</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Next, we initialize the attributes required by the agent, e.g., q_values, model, tau, etc.</span></span><br><span class="line">        <span class="comment"># The visitation-counts can be stored as a table as well, like the action values </span></span><br><span class="line">        self.q_values = np.zeros((self.num_states, self.num_actions))</span><br><span class="line">        self.tau = np.zeros((self.num_states, self.num_actions))</span><br><span class="line">        self.actions = list(range(self.num_actions))</span><br><span class="line">        self.past_action = <span class="number">-1</span></span><br><span class="line">        self.past_state = <span class="number">-1</span></span><br><span class="line">        self.model = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>Now first up, implement the <code>update_model</code> method. Note that this is different from Dyna-Q in the aforementioned way.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQPlusAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_model</span><span class="params">(self, past_state, past_action, state, reward)</span>:</span></span><br><span class="line">    <span class="string">"""updates the model </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        past_state  (int): s</span></span><br><span class="line"><span class="string">        past_action (int): a</span></span><br><span class="line"><span class="string">        state       (int): s'</span></span><br><span class="line"><span class="string">        reward      (int): r</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recall that when adding a state-action to the model, if the agent is visiting the state</span></span><br><span class="line">    <span class="comment">#    for the first time, then the remaining actions need to be added to the model as well</span></span><br><span class="line">    <span class="comment">#    with zero reward and a transition into itself.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note: do *not* update the visitation-counts here. We will do that in `agent_step`.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># (3 lines)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> past_state <span class="keyword">not</span> <span class="keyword">in</span> self.model:</span><br><span class="line">        self.model[past_state] = &#123;past_action : (state, reward)&#125;</span><br><span class="line">        <span class="comment"># ----------------</span></span><br><span class="line">        <span class="comment"># your code here</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> self.actions:</span><br><span class="line">            <span class="keyword">if</span> action != past_action:</span><br><span class="line">                self.model[past_state][action] = (past_state, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ----------------</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.model[past_state][past_action] = (state, reward)</span><br></pre></td></tr></table></figure>
<h3 id="Test-update-model-1"><a href="#Test-update-model-1" class="headerlink" title="Test update_model()"></a>Test <code>update_model()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Tested Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># The contents of the cell will be tested by the autograder.</span></span><br><span class="line"><span class="comment"># If they do not pass here, they will not pass there.</span></span><br><span class="line"></span><br><span class="line">actions = []</span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>, </span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQPlusAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">agent.tau[<span class="number">0</span>][<span class="number">0</span>] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="number">1</span>: (<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="number">2</span>: (<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="number">3</span>: (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="number">2</span>: (<span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="number">3</span>: (<span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br></pre></td></tr></table></figure>
<p>Next, you will implement the <code>planning_step()</code> method. This will be very similar to the one you implemented in <code>DynaQAgent</code>, but here you will be adding the exploration bonus to the reward in the simulated transition.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQPlusAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">planning_step</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""performs planning, i.e. indirect RL.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># The indirect RL step:</span></span><br><span class="line">    <span class="comment"># - Choose a state and action from the set of experiences that are stored in the model. (~2 lines)</span></span><br><span class="line">    <span class="comment"># - Query the model with this state-action pair for the predicted next state and reward.(~1 line)</span></span><br><span class="line">    <span class="comment"># - **Add the bonus to the reward** (~1 line)</span></span><br><span class="line">    <span class="comment"># - Update the action values with this simulated experience.                            (2~4 lines)</span></span><br><span class="line">    <span class="comment"># - Repeat for the required number of planning steps.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note that the update equation is different for terminal and non-terminal transitions. </span></span><br><span class="line">    <span class="comment"># To differentiate between a terminal and a non-terminal next state, assume that the model stores</span></span><br><span class="line">    <span class="comment"># the terminal state as a dummy state like -1</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Important: remember you have a random number generator 'planning_rand_generator' as </span></span><br><span class="line">    <span class="comment">#     a part of the class which you need to use as self.planning_rand_generator.choice()</span></span><br><span class="line">    <span class="comment">#     For the sake of reproducibility and grading, *do not* use anything else like </span></span><br><span class="line">    <span class="comment">#     np.random.choice() for performing search control.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.planning_steps):</span><br><span class="line">    </span><br><span class="line">        s = self.planning_rand_generator.choice(list(self.model.keys()))</span><br><span class="line">        a = self.planning_rand_generator.choice(list(self.model[s].keys()))</span><br><span class="line"></span><br><span class="line">        (next_s,r) = self.model[s][a]</span><br><span class="line">        r += self.kappa * np.sqrt(self.tau[s][a])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> next_s == <span class="number">-1</span>:</span><br><span class="line">            expect = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            expect = self.gamma * np.max(self.q_values[next_s])</span><br><span class="line">        self.q_values[s,a] += self.step_size * (r + expect - self.q_values[s,a])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>
<h3 id="Test-planning-step-1"><a href="#Test-planning-step-1" class="headerlink" title="Test planning_step()"></a>Test <code>planning_step()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do not modify this cell!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Test code for planning_step() ##</span></span><br><span class="line"></span><br><span class="line">actions = []</span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>, </span><br><span class="line">              <span class="string">"kappa"</span>: <span class="number">0.001</span>,</span><br><span class="line">              <span class="string">"planning_steps"</span>: <span class="number">4</span>,</span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQPlusAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>)</span><br><span class="line">agent.tau += <span class="number">1</span></span><br><span class="line">agent.tau[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">agent.update_model(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.tau += <span class="number">1</span></span><br><span class="line">agent.tau[<span class="number">0</span>][<span class="number">2</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">agent.update_model(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">agent.tau += <span class="number">1</span></span><br><span class="line">agent.tau[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">agent.planning_step()</span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">1</span>: (<span class="number">-1</span>, <span class="number">1</span>), </span><br><span class="line">        <span class="number">0</span>: (<span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">2</span>: (<span class="number">1</span>, <span class="number">1</span>), </span><br><span class="line">        <span class="number">3</span>: (<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="number">1</span>, <span class="number">1</span>), </span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">2</span>: (<span class="number">2</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">3</span>: (<span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.10014142</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.00036373</span>, <span class="number">0</span>, <span class="number">0.00017321</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, expected_values)</span><br></pre></td></tr></table></figure>
<p>Again, before you move on to implement the rest of the agent methods, here are the couple of helper functions that you’ve used in the previous assessments for choosing an action using an $\epsilon$-greedy policy.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQPlusAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">argmax</span><span class="params">(self, q_values)</span>:</span></span><br><span class="line">    <span class="string">"""argmax with random tie-breaking</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        q_values (Numpy array): the array of action values</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        action (int): an action with the highest value</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    top = float(<span class="string">"-inf"</span>)</span><br><span class="line">    ties = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(q_values)):</span><br><span class="line">        <span class="keyword">if</span> q_values[i] &gt; top:</span><br><span class="line">            top = q_values[i]</span><br><span class="line">            ties = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> q_values[i] == top:</span><br><span class="line">            ties.append(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.rand_generator.choice(ties)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose_action_egreedy</span><span class="params">(self, state)</span>:</span></span><br><span class="line">    <span class="string">"""returns an action using an epsilon-greedy policy w.r.t. the current action-value function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Important: assume you have a random number generator 'rand_generator' as a part of the class</span></span><br><span class="line"><span class="string">                which you can use as self.rand_generator.choice() or self.rand_generator.rand()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        state (List): coordinates of the agent (two elements)</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        The action taken w.r.t. the aforementioned epsilon-greedy policy</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.rand_generator.rand() &lt; self.epsilon:</span><br><span class="line">        action = self.rand_generator.choice(self.actions)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        values = self.q_values[state]</span><br><span class="line">        action = self.argmax(values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br></pre></td></tr></table></figure>
<p>Now implement the rest of the agent-related methods, namely <code>agent_start</code>, <code>agent_step</code>, and <code>agent_end</code>. Again, these will be very similar to the ones in the <code>DynaQAgent</code>, but you will have to think of a way to update the counts since the last visit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">%%add_to DynaQPlusAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Graded Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_start</span><span class="params">(self, state)</span>:</span></span><br><span class="line">    <span class="string">"""The first method called when the experiment starts, called after</span></span><br><span class="line"><span class="string">    the environment starts.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        state (Numpy array): the state from the</span></span><br><span class="line"><span class="string">            environment's env_start function.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (int) The first action the agent takes.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># given the state, select the action using self.choose_action_egreedy(), </span></span><br><span class="line">    <span class="comment"># and save current state and action (~2 lines)</span></span><br><span class="line">    <span class="comment">### self.past_state = ?</span></span><br><span class="line">    <span class="comment">### self.past_action = ?</span></span><br><span class="line">    <span class="comment"># Note that the last-visit counts are not updated here.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.past_state = state</span><br><span class="line">    self.past_action = self.choose_action_egreedy(state)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> self.past_action</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_step</span><span class="params">(self, reward, state)</span>:</span></span><br><span class="line">    <span class="string">"""A step taken by the agent.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        reward (float): the reward received for taking the last action taken</span></span><br><span class="line"><span class="string">        state (Numpy array): the state from the</span></span><br><span class="line"><span class="string">            environment's step based on where the agent ended up after the</span></span><br><span class="line"><span class="string">            last step</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (int) The action the agent is taking.</span></span><br><span class="line"><span class="string">    """</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Update the last-visited counts (~2 lines)</span></span><br><span class="line">    <span class="comment"># - Direct-RL step (1~3 lines)</span></span><br><span class="line">    <span class="comment"># - Model Update step (~1 line)</span></span><br><span class="line">    <span class="comment"># - `planning_step` (~1 line)</span></span><br><span class="line">    <span class="comment"># - Action Selection step (~1 line)</span></span><br><span class="line">    <span class="comment"># Save the current state and action before returning the action to be performed. (~2 lines)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.tau += <span class="number">1</span></span><br><span class="line">    self.tau[self.past_state,self.past_action] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    self.q_values[self.past_state,self.past_action] += self.step_size * (reward + self.gamma * np.max(self.q_values[state]) - self.q_values[self.past_state,self.past_action])</span><br><span class="line">    self.update_model(self.past_state, self.past_action, state, reward)</span><br><span class="line">    self.planning_step()</span><br><span class="line">    </span><br><span class="line">    action = self.choose_action_egreedy(state)</span><br><span class="line">    self.past_state = state</span><br><span class="line">    self.past_action = action</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> self.past_action</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">agent_end</span><span class="params">(self, reward)</span>:</span></span><br><span class="line">    <span class="string">"""Called when the agent terminates.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        reward (float): the reward the agent received for entering the</span></span><br><span class="line"><span class="string">            terminal state.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Again, add the same components you added in agent_step to augment Dyna-Q into Dyna-Q+</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    self.tau += <span class="number">1</span></span><br><span class="line">    self.tau[self.past_state,self.past_action] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    self.q_values[self.past_state,self.past_action] += self.step_size * (reward  - self.q_values[self.past_state,self.past_action])</span><br><span class="line">    self.update_model(self.past_state, self.past_action, <span class="number">-1</span>, reward)</span><br><span class="line">    self.planning_step()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>
<h3 id="Test-agent-start-agent-step-and-agent-end-1"><a href="#Test-agent-start-agent-step-and-agent-end-1" class="headerlink" title="Test agent_start(), agent_step(), and agent_end()"></a>Test <code>agent_start()</code>, <code>agent_step()</code>, and <code>agent_end()</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># Tested Cell</span></span><br><span class="line"><span class="comment"># -----------</span></span><br><span class="line"><span class="comment"># The contents of the cell will be tested by the autograder.</span></span><br><span class="line"><span class="comment"># If they do not pass here, they will not pass there.</span></span><br><span class="line"></span><br><span class="line">agent_info = &#123;<span class="string">"num_actions"</span>: <span class="number">4</span>, </span><br><span class="line">              <span class="string">"num_states"</span>: <span class="number">3</span>, </span><br><span class="line">              <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"step_size"</span>: <span class="number">0.1</span>, </span><br><span class="line">              <span class="string">"discount"</span>: <span class="number">1.0</span>,</span><br><span class="line">              <span class="string">"kappa"</span>: <span class="number">0.001</span>,</span><br><span class="line">              <span class="string">"random_seed"</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="string">"planning_steps"</span>: <span class="number">4</span>,</span><br><span class="line">              <span class="string">"planning_random_seed"</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">agent = DynaQPlusAgent()</span><br><span class="line">agent.agent_init(agent_info)</span><br><span class="line"></span><br><span class="line">action = agent.agent_start(<span class="number">0</span>) <span class="comment"># state</span></span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.tau, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">assert</span> agent.model == &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># test agent step</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line">action = agent.agent_step(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">3</span></span><br><span class="line"></span><br><span class="line">action = agent.agent_step(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> action == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">expected_tau = np.array([</span><br><span class="line">    [<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.all(agent.tau == expected_tau)</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0.0191</span>, <span class="number">0.271</span>, <span class="number">0.0</span>, <span class="number">0.0191</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.000183847763</span>, <span class="number">0.000424264069</span>, <span class="number">0</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, expected_values)</span><br><span class="line"></span><br><span class="line">expected_model = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">1</span>), </span><br><span class="line">        <span class="number">0</span>: (<span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">2</span>: (<span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">3</span>: (<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        <span class="number">3</span>: (<span class="number">1</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">0</span>: (<span class="number">2</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">1</span>: (<span class="number">2</span>, <span class="number">0</span>), </span><br><span class="line">        <span class="number">2</span>: (<span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"><span class="comment"># test agent end</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line">agent.agent_end(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">expected_tau = np.array([</span><br><span class="line">    [<span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.all(agent.tau == expected_tau)</span><br><span class="line"></span><br><span class="line">expected_values = np.array([</span><br><span class="line">    [<span class="number">0.0191</span>, <span class="number">0.344083848</span>, <span class="number">0</span>, <span class="number">0.0444632051</span>],</span><br><span class="line">    [<span class="number">0.0191732051</span>, <span class="number">0.19</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0.000183847763</span>, <span class="number">0.000424264069</span>, <span class="number">0</span>],</span><br><span class="line">])</span><br><span class="line"><span class="keyword">assert</span> np.allclose(agent.q_values, expected_values)</span><br><span class="line"></span><br><span class="line">expected_model = &#123;<span class="number">0</span>: &#123;<span class="number">1</span>: (<span class="number">2</span>, <span class="number">1</span>), <span class="number">0</span>: (<span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>: (<span class="number">0</span>, <span class="number">0</span>), <span class="number">3</span>: (<span class="number">0</span>, <span class="number">0</span>)&#125;, <span class="number">2</span>: &#123;<span class="number">3</span>: (<span class="number">1</span>, <span class="number">0</span>), <span class="number">0</span>: (<span class="number">2</span>, <span class="number">0</span>), <span class="number">1</span>: (<span class="number">2</span>, <span class="number">0</span>), <span class="number">2</span>: (<span class="number">2</span>, <span class="number">0</span>)&#125;, <span class="number">1</span>: &#123;<span class="number">1</span>: (<span class="number">-1</span>, <span class="number">1</span>), <span class="number">0</span>: (<span class="number">1</span>, <span class="number">0</span>), <span class="number">2</span>: (<span class="number">1</span>, <span class="number">0</span>), <span class="number">3</span>: (<span class="number">1</span>, <span class="number">0</span>)&#125;&#125;</span><br><span class="line"><span class="keyword">assert</span> agent.model == expected_model</span><br></pre></td></tr></table></figure>
<h3 id="Experiment-Dyna-Q-agent-in-the-changing-environment"><a href="#Experiment-Dyna-Q-agent-in-the-changing-environment" class="headerlink" title="Experiment: Dyna-Q+ agent in the _changing_ environment"></a>Experiment: Dyna-Q+ agent in the _changing_ environment</h3><p>Okay, now we’re ready to test our Dyna-Q+ agent on the Shortcut Maze. As usual, we will average the results over 30 independent runs of the experiment.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Experiment parameters</span></span><br><span class="line">experiment_parameters = &#123;</span><br><span class="line">    <span class="string">"num_runs"</span> : <span class="number">30</span>,                     <span class="comment"># The number of times we run the experiment</span></span><br><span class="line">    <span class="string">"num_max_steps"</span> : <span class="number">6000</span>,              <span class="comment"># The number of steps per experiment</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment parameters</span></span><br><span class="line">environment_parameters = &#123; </span><br><span class="line">    <span class="string">"discount"</span>: <span class="number">0.95</span>,</span><br><span class="line">    <span class="string">"change_at_n"</span>: <span class="number">3000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent parameters</span></span><br><span class="line">agent_parameters = &#123;  </span><br><span class="line">    <span class="string">"num_states"</span> : <span class="number">54</span>,</span><br><span class="line">    <span class="string">"num_actions"</span> : <span class="number">4</span>, </span><br><span class="line">    <span class="string">"epsilon"</span>: <span class="number">0.1</span>, </span><br><span class="line">    <span class="string">"step_size"</span> : <span class="number">0.5</span>,</span><br><span class="line">    <span class="string">"planning_steps"</span> : [<span class="number">50</span>]      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">current_env = ShortcutMazeEnvironment   <span class="comment"># The environment</span></span><br><span class="line">current_agent = DynaQPlusAgent          <span class="comment"># The agent</span></span><br><span class="line"></span><br><span class="line">data_qplus = run_experiment_with_state_visitations(current_env, current_agent, environment_parameters, agent_parameters, experiment_parameters, <span class="string">"Dyna-Q+"</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Planning steps :  50


100%|██████████| 30/30 [04:21&lt;00:00,  8.72s/it]
</code></pre><p>Let’s compare the Dyna-Q and Dyna-Q+ agents with <code>planning_steps=50</code> each.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_cumulative_reward_comparison</span><span class="params">(data1, data2)</span>:</span></span><br><span class="line"></span><br><span class="line">    cum_reward_q = data1[<span class="string">'cum_reward_all'</span>][<span class="number">2</span>]</span><br><span class="line">    cum_reward_qPlus = data2[<span class="string">'cum_reward_all'</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    plt.plot(np.mean(cum_reward_qPlus, axis=<span class="number">0</span>), label=<span class="string">'Dyna-Q+'</span>)</span><br><span class="line">    plt.plot(np.mean(cum_reward_q, axis=<span class="number">0</span>), label=<span class="string">'Dyna-Q'</span>)</span><br><span class="line"></span><br><span class="line">    plt.axvline(x=<span class="number">3000</span>, linestyle=<span class="string">'--'</span>, color=<span class="string">'grey'</span>, alpha=<span class="number">0.4</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Timesteps'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Cumulative\nreward'</span>, rotation=<span class="number">0</span>, labelpad=<span class="number">60</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.title(<span class="string">'Average performance of Dyna-Q and Dyna-Q+ agents in the Shortcut Maze\n'</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line">plot_cumulative_reward_comparison(dataq, data_qplus)</span><br></pre></td></tr></table></figure>
<p><img src="output_64_0.png" alt="png"></p>
<p>What do you observe? (For reference, your graph should look like <a href="http://www.incompleteideas.net/book/RLbook2018.pdf#page=189" target="_blank" rel="noopener">Figure 8.5 in Chapter 8</a> of the RL textbook)</p>
<p>The slope of the curve increases for the Dyna-Q+ curve shortly after the shortcut opens up after 3000 steps, which indicates that the rate of receiving the positive reward increases. This implies that the Dyna-Q+ agent finds the shorter path to the goal.</p>
<p>To verify this, let us plot the state-visitations of the Dyna-Q+ agent before and after the shortcut opens up.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"><span class="comment"># Discussion Cell</span></span><br><span class="line"><span class="comment"># ---------------</span></span><br><span class="line"></span><br><span class="line">plot_state_visitations(data_qplus, [<span class="string">'Dyna-Q+ : State visitations before the env changes'</span>, <span class="string">'Dyna-Q+ : State visitations after the env changes'</span>], <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><img src="output_66_0.png" alt="png"></p>
<p>What do you observe?</p>
<p>Before the shortcut opens up, like Dyna-Q, the Dyna-Q+ agent finds the sole, long path to the goal. But because the Dyna-Q+ agent keeps exploring, it succeeds in discovering the shortcut once it opens up, which leads to the goal faster. So the bonus reward heuristic is effective in helping the agent explore and find changes in the environment without degrading the performance. </p>
<h2 id="Wrapping-Up"><a href="#Wrapping-Up" class="headerlink" title="Wrapping Up"></a>Wrapping Up</h2><p>Congratulations! You have:</p>
<ol>
<li>implemented Dyna-Q, a model-based approach to RL;</li>
<li>implemented Dyna-Q+, a variant of Dyna-Q with an exploration bonus that encourages exploration; </li>
<li>conducted scientific experiments to empirically validate the exploration/exploitation dilemma in the planning context on an environment that changes with time.</li>
</ol>
<p>Some points to ponder about:</p>
<ol>
<li>At what cost does Dyna-Q+ improve over Dyna-Q?</li>
<li>In general, what is the trade-off of using model-based methods like Dyna-Q over model-free methods like Q-learning?</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Planning-and-learning-with-Tabular-Methods/2020/09/29/" rel="next" title="Planning and learning with Tabular Methods">
                <i class="fa fa-chevron-left"></i> Planning and learning with Tabular Methods
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Your-First-GAN/2020/10/09/" rel="prev" title="Your First GAN">
                Your First GAN <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate article here</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Ruochi Zhang WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    

    
      <div id="bitcoin" style="display: inline-block">
        <img id="vemo_qr" src="/images/venmo.png" alt="Ruochi Zhang Bitcoin">
        <p>Venmo(last 4 digits 1570)</p>
      </div>
    

  </div>
</div>

      </div>
    


  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Ruochi Zhang">
            
              <p class="site-author-name" itemprop="name">Ruochi Zhang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">259</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zhangruochi" target="_blank" title="GitHub rel=" external nofollow"">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zrc720@gmail.com" target="_blank" title="E-Mail rel=" external nofollow"">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Friend links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.healthinformaticslab.org" title="HILab" target="_blank" rel="external nofollow">HILab</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.shihaizhou.com" title="Rose" target="_blank" rel="external nofollow">Rose</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/cherish_CX/" title="Chunxia" target="_blank" rel="external nofollow">Chunxia</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Assignment-Dyna-Q-and-Dyna-Q"><span class="nav-text">Assignment: Dyna-Q and Dyna-Q+</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Shortcut-Maze-Environment"><span class="nav-text">The Shortcut Maze Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Packages"><span class="nav-text">Packages</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Section-1-Dyna-Q"><span class="nav-text">Section 1: Dyna-Q</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-update-model"><span class="nav-text">Test update_model()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-planning-step"><span class="nav-text">Test planning_step()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-agent-start-agent-step-and-agent-end"><span class="nav-text">Test agent_start(), agent_step(), and agent_end()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Experiment-Dyna-Q-agent-in-the-maze-environment"><span class="nav-text">Experiment: Dyna-Q agent in the maze environment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Experiment-s-Dyna-Q-agent-in-the-changing-maze-environment"><span class="nav-text">Experiment(s): Dyna-Q agent in the _changing_ maze environment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Section-2-Dyna-Q"><span class="nav-text">Section 2: Dyna-Q+</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-update-model-1"><span class="nav-text">Test update_model()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-planning-step-1"><span class="nav-text">Test planning_step()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-agent-start-agent-step-and-agent-end-1"><span class="nav-text">Test agent_start(), agent_step(), and agent_end()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Experiment-Dyna-Q-agent-in-the-changing-environment"><span class="nav-text">Experiment: Dyna-Q+ agent in the _changing_ environment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wrapping-Up"><span class="nav-text">Wrapping Up</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ruochi Zhang</span>
  
  
</div>








        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'qW3MLcAgcX96sB6qbegeL7rP-gzGzoHsz',
        appKey: 'GL6JvT9DgGxqYrY5Vj6bXVuv',
        lang: 'en',
        placeholder: 'Thank you for your reply',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  
  

  
  


  

  

  
</body>
</html>
